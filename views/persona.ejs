<!DOCTYPE html>
<html>
<head>
    <title><%= personData.person_name%></title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body class="p-6">
<%- include('./components/navbar_pers',{personName: personData.person_name}) %>
<div style="display: flex">
    <!--Persona-->
    <div style = "width: 30%">
        <div class="card bg-base-100 w-85 shadow-sm ">
            <figure class="relative w-90% h-96 bg-base-200 flex items-center justify-center rounded-xl overflow-hidden">
                <!-- Skeleton visible al principio -->
                <div id="person-loader" class="absolute inset-0 flex flex-col gap-4 p-4 bg-base-200">
                    <div class="skeleton h-3/4 w-full"></div>
                    <div class="skeleton h-4 w-28"></div>
                    <div class="skeleton h-4 w-full"></div>
                    <div class="skeleton h-4 w-3/4"></div>
                </div>
                <!-- Imagen oculta inicialmente -->
                <img
                        id="person-image"
                        src=""
                        alt="FOTO PERSONA"
                        class="hidden"
                />
            </figure>
            <div class="card-body">
                <h2 class="card-title"><%=personData.person_name%></h2>
                <ul>
                    <li>Gender: <%=personData.gender%></li>
                </ul>
                <div class="card-actions justify-end">
                    <button class="btn btn-primary">Buy Now</button>
                </div>
            </div>
        </div>
    </div>
    <!--Peliculas-->
    <div style="width: 70%">
        <!-- Tabs actuado/ dirigido -->
        <div class="tabs tabs-lift w-full">
            <!-- Tabs para actuadas -->
            <input type="radio" name="my_tabs_3" class="tab" aria-label="Peliculas Actuadas" <% if (personData.actedMovies.length !== 0) { %> checked <% } %> />
            <div class="tab-content bg-base-100 border-base-300 p-6">
                <% if (personData.actedMovies.length === 0) { %>
                    <p>No actuó en ninguna pelicula</p>
                <% } else { %>
                    <!-- Dropdown Order By (solo en esta pestaña) -->
                    <div class="flex">
                        <a href="?offset=<%= personData.offset %>&order=<%=personData.order%>&desc=<%=personData.ascOrDesc === 't' ? 'f' : 't' %>" style="margin-bottom: 15px; height: 31px" class="btn flex justify-end mb-4">
                            <% if (personData.ascOrDesc === 't') { %>
                                ↓
                            <% } else { %>
                                ↑
                            <% } %>
                        </a>
                        <div style="margin-bottom: 15px" class="flex justify-end mb-4">
                            <details class="dropdown">
                                <summary class="btn btn-sm"><%=personData.order%></summary>
                                <ul class="menu dropdown-content bg-base-100 rounded-box z-10 w-52 p-2 shadow">
                                    <li><a href="?offset=<%= personData.offset %>&order=Popularity&desc=<%=personData.ascOrDesc%>">Popularity</a></li>
                                    <li><a href="?offset=<%= personData.offset %>&order=Title&desc=<%=personData.ascOrDesc%>">Title</a></li>
                                    <li><a href="?offset=<%= personData.offset %>&order=Release_date&desc=<%=personData.ascOrDesc%>">Release Date</a></li>
                                </ul>
                            </details>
                        </div>
                    </div>

                    <!-- Contenido Peliculas actuadas -->
                    <div class="grid grid-cols-4 md:grid-cols-4 gap-6">
                        <% personData.actedMovies
                        .forEach((movie) => { %>
                            <div style="align-content: center" class="card bg-base-100 shadow-sm hover:shadow-md transition-shadow duration-200">
                                <!--<div style="margin:5px; align-self: center" class="rating">
                                    <input type="radio" name="rating-2" class="mask mask-star-2 bg-orange-400" aria-label="1 star" />
                                    <input type="radio" name="rating-2" class="mask mask-star-2 bg-orange-400" aria-label="2 star" />
                                    <input type="radio" name="rating-2" class="mask mask-star-2 bg-orange-400" aria-label="3 star" />
                                    <input type="radio" name="rating-2" class="mask mask-star-2 bg-orange-400" aria-label="4 star" />
                                    <input type="radio" name="rating-2" class="mask mask-star-2 bg-orange-400" aria-label="5 star" < if (personData.popularity >=100000000) { > checked < } >/>
                                </div> -->
                                <figure class="relative h-72 bg-base-200 flex items-center justify-center rounded-xl overflow-hidden">
                                    <!-- Skeleton visible al principio -->
                                    <div class="absolute inset-0 flex flex-col gap-4 p-4 bg-base-200 animate-pulse movie-skeleton rounded-xl overflow-hidden">
                                        <div class="skeleton h-3/4 w-full rounded-xl"></div>
                                        <div class="skeleton h-4 w-32"></div>
                                        <div class="skeleton h-4 w-3/4"></div>
                                    </div>

                                    <!-- Imagen oculta inicialmente -->
                                    <img
                                            data-title="<%= movie.title %>"
                                            data-type="<%= movie.photo_path %>"
                                    class="hidden movie-poster"
                                    alt="Poster"
                                    />
                                </figure>
                                <div class="card-body p-4">
                                    <h2 class="card-title text-base">
                                        <a class="link link-hover" href="/pelicula/<%= movie.movie_id %>">
                                            <%= movie.title %> (<%= new Date(movie.release_date).getFullYear() %>)
                                        </a>
                                    </h2>
                                    <p><%=movie.character_name%></p>
                                </div>
                            </div>
                        <% }); %>
                    </div>

                <% } %>
            </div>

            <!-- Tabs para dirigidas -->
            <input type="radio" name="my_tabs_3" class="tab" aria-label="Peliculas Dirigidas" <% if (personData.actedMovies.length === 0) { %> checked <% } %>/>
            <div class="tab-content bg-base-100 border-base-300 p-6">
                <% if (personData.directedMovies.length === 0) { %>
                    <p>No dirigió ninguna película</p>
                <% } else { %>
                    <!-- Dropdown Order By (solo en esta pestaña) -->
                        <div class="flex">
                            <a href="?offset=<%= personData.offset %>&order=<%=personData.order%>&desc=<%=personData.ascOrDesc === 't' ? 'f' : 't' %>" style="margin-bottom: 15px; height: 31px" class="btn flex justify-end mb-4">
                                <% if (personData.ascOrDesc === 't') { %>
                                    ↓
                                <% } else { %>
                                    ↑
                                <% } %>
                            </a>
                            <div style="margin-bottom: 15px" class="flex justify-end mb-4">
                                <details class="dropdown">
                                    <summary class="btn btn-sm"><%=personData.order%></summary>
                                    <ul class="menu dropdown-content bg-base-100 rounded-box z-10 w-52 p-2 shadow">
                                        <li><a href="?offset=<%= personData.offset %>&order=Popularity&desc=<%=personData.ascOrDesc%>">Popularity</a></li>
                                        <li><a href="?offset=<%= personData.offset %>&order=Title&desc=<%=personData.ascOrDesc%>">Title</a></li>
                                        <li><a href="?offset=<%= personData.offset %>&order=Release_date&desc=<%=personData.ascOrDesc%>">Release Date</a></li>
                                    </ul>
                                </details>
                            </div>
                        </div>


                    <!-- Contenido Peliculas dirigidas -->
                    <div class="grid grid-cols-4 md:grid-cols-4 gap-6">
                        <% personData.directedMovies
                        .forEach((movie) => { %>
                            <div class="card bg-base-100 shadow-sm hover:shadow-md transition-shadow duration-200">
                                <figure>
                                    <img src="<%=movie.photo_path%>" alt="Poster" />
                                </figure>
                                <div class="card-body p-4">
                                    <h2 class="card-title text-base">
                                        <a class="link link-hover" href="/pelicula/<%= movie.movie_id %>">
                                            <%= movie.title %> (<%= new Date(movie.release_date).getFullYear() %>)
                                        </a>
                                    </h2>
                                </div>
                            </div>
                        <% }); %>
                    </div>
                <% } %>
            </div>

        </div>

        <!-- Paginado -->
        <div class="join mt-6 flex justify-center">
            <!-- Boton para ir para atras -->
            <% if(personData.offset === 0) {%>
                <button class="join-item btn">«</button>
            <%} else{%>
            <a href= "/persona/<%=personData.person_id%>?offset=<%=personData.offset - 8 %>&order=<%=personData.order%>&desc=<%=personData.ascOrDesc%>" class="join-item btn">«</a>
            <%}%>

            <!-- Botton con el nro de pagina -->
            <button class="join-item btn">Page <%=(personData.offset/8)+1%></button>

            <!-- Boton para ir para atras -->
            <% if((personData.offset + 10) >= personData.totalActedMovies) {%>
                <button class="join-item btn">»</button>
            <%} else{%>
            <a href="/persona/<%=personData.person_id%>?offset=<%=personData.offset + 8%>&order=<%=personData.order%>&desc=<%=personData.ascOrDesc%>" class="join-item btn">»</a>
            <%}%>
        </div>
    </div>

</div>
</body>
<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const loader = document.getElementById("person-loader");
        const img = document.getElementById("person-image");

        // Nombre de la persona desde EJS
        const personName = "<%= personData.person_name %>";

        // API key pública desde el backend (la inyectás al render)
        const apiKey = "<%= tmdbApiKey %>";

        try {
            // Mostrar loader
            loader.classList.remove("hidden");

            // Buscar persona en TMDB
            const response = await fetch(`https://api.themoviedb.org/3/search/person?api_key=${apiKey}&query=${encodeURIComponent(personName)}`);
            const data = await response.json();

            if(data.results && data.results.length > 0 && data.results[0].profile_path) {
                img.src = `https://image.tmdb.org/t/p/w300${data.results[0].profile_path}`;
            } else {
                img.src = "https://upload.wikimedia.org/wikipedia/commons/a/a3/Image-not-found.png";
            }

            // Cuando la imagen cargue, ocultamos el loader y mostramos la imagen
            img.onload = () => {
                loader.classList.add("hidden");
                img.classList.remove("hidden");
            };

        } catch (err) {
            console.error("Error cargando imagen:", err);
            loader.classList.add("hidden");
            img.src = "https://upload.wikimedia.org/wikipedia/commons/a/a3/Image-not-found.png";
            img.classList.remove("hidden");
        }
        document.dispatchEvent(new Event("script1Done"));
    });
</script>
<script>
    document.addEventListener("script1Done", async () => {
        console.log("Script 1 terminó, ejecutando Script 2 (cargar posters de películas)");

        const apiKey = "<%= tmdbApiKey %>";
        const posters = document.querySelectorAll(".movie-poster");

        posters.forEach(async (img) => {
            const title = img.dataset.title;
            const fallback = img.dataset.type;

            try {
                const response = await fetch(
                    `https://api.themoviedb.org/3/search/movie?api_key=${apiKey}&query=${encodeURIComponent(title)}`
                );
                const data = await response.json();

                if (data.results && data.results.length > 0 && data.results[0].poster_path) {
                    img.src = `https://image.tmdb.org/t/p/w200${data.results[0].poster_path}`;
                } else {
                    img.src = fallback || "https://upload.wikimedia.org/wikipedia/commons/a/a3/Image-not-found.png";
                }

                img.onload = () => {
                    const skeleton = img.closest("figure").querySelector(".movie-skeleton");
                    skeleton.classList.add("hidden");
                    img.classList.remove("hidden");
                };
            } catch (err) {
                console.error(`Error cargando imagen de ${title}:`, err);
                const skeleton = img.closest("figure").querySelector(".movie-skeleton");
                skeleton.classList.add("hidden");
                img.src = fallback || "https://upload.wikimedia.org/wikipedia/commons/a/a3/Image-not-found.png";
                img.classList.remove("hidden");
            }
        });
    });
</script>

</html>
