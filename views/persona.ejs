<!DOCTYPE html>
<html>
<head>
    <title><%= personData.person_name%></title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body class="p-6">
<div style="display: flex">
    <!--Persona-->
    <div style = "width: 30%">
        <div class="card bg-base-100 w-85 shadow-sm ">
            <figure class="relative w-64 h-96 bg-base-200 flex items-center justify-center rounded-xl overflow-hidden">
                <!-- Loader visible al principio -->
                <span id="person-loader" class="loading loading-spinner loading-lg text-blue-600"></span>
                <!-- Imagen oculta inicialmente -->
                <img
                        id="person-image"
                        src=""
                        alt="FOTO PERSONA"
                        class="hidden"
                />
            </figure>
            <div class="card-body">
                <h2 class="card-title"><%=personData.person_name%></h2>
                <ul>
                    <li>Gender: <%=personData.gender%></li>
                </ul>
                <div class="card-actions justify-end">
                    <button class="btn btn-primary">Buy Now</button>
                </div>
            </div>
        </div>
    </div>
    <!--Peliculas-->
    <div style="width: 70%">
        <!-- Tabs actuado/ dirigido -->
        <div class="tabs tabs-lift w-full">
            <!-- Tabs para actuadas -->
            <input type="radio" name="my_tabs_3" class="tab" aria-label="Peliculas Actuadas" <% if (personData.actedMovies.length !== 0) { %> checked <% } %> />
            <div class="tab-content bg-base-100 border-base-300 p-6">
                <% if (personData.actedMovies.length === 0) { %>
                    <p>No actuó en ninguna pelicula</p>
                <% } else { %>
                    <!-- Dropdown Order By (solo en esta pestaña) -->
                    <div style="margin-bottom: 15px" class="flex justify-end mb-4">
                        <details class="dropdown">
                            <summary class="btn btn-sm">Order By</summary>
                            <ul class="menu dropdown-content bg-base-100 rounded-box z-10 w-52 p-2 shadow">
                                <li><a href="?offset=<%= personData.offset %>&order=popularity">Popularity</a></li>
                                <li><a href="?offset=<%= personData.offset %>&order=title">Alphabetical</a></li>
                                <li><a href="?offset=<%= personData.offset %>&order=release_date">Release Date</a></li>
                            </ul>
                        </details>
                    </div>

                    <!-- Contenido Peliculas actuadas -->
                    <div class="grid grid-cols-4 md:grid-cols-4 gap-6">
                        <% personData.actedMovies
                        .forEach((movie) => { %>
                            <div class="card bg-base-100 shadow-sm hover:shadow-md transition-shadow duration-200">
                                <figure>
                                    <img src="<%=movie.photo_path%>" alt="Poster" />
                                </figure>
                                <div class="card-body p-4">
                                    <h2 class="card-title text-base">
                                        <a class="link link-hover" href="/pelicula/<%= movie.movie_id %>">
                                            <%= movie.title %> (<%= new Date(movie.release_date).getFullYear() %>)
                                        </a>
                                    </h2>
                                    <p><%=movie.character_name%></p>
                                </div>
                            </div>
                        <% }); %>
                    </div>

                <% } %>
            </div>

            <!-- Tabs para dirigidas -->
            <input type="radio" name="my_tabs_3" class="tab" aria-label="Peliculas Dirigidas" <% if (personData.actedMovies.length === 0) { %> checked <% } %>/>
            <div class="tab-content bg-base-100 border-base-300 p-6">
                <% if (personData.directedMovies.length === 0) { %>
                    <p>No dirigió ninguna película</p>
                <% } else { %>
                    <!-- Dropdown Order By (solo en esta pestaña) -->
                    <div style="margin-bottom: 15px" class="flex justify-end mb-4">
                        <details class="dropdown">
                            <summary class="btn btn-sm">Order By</summary>
                            <ul class="menu dropdown-content bg-base-100 rounded-box z-10 w-52 p-2 shadow">
                                <li><a href="?offset=<%= personData.offset %>&order=popularity">Popularity</a></li>
                                <li><a href="?offset=<%= personData.offset %>&order=title">Alphabetical</a></li>
                                <li><a href="?offset=<%= personData.offset %>&order=release_date">Release Date</a></li>
                            </ul>
                        </details>
                    </div>


                    <!-- Contenido Peliculas dirigidas -->
                    <div class="grid grid-cols-4 md:grid-cols-4 gap-6">
                        <% personData.directedMovies
                        .forEach((movie) => { %>
                            <div class="card bg-base-100 shadow-sm hover:shadow-md transition-shadow duration-200">
                                <figure>
                                    <img src="<%=movie.photo_path%>" alt="Poster" />
                                </figure>
                                <div class="card-body p-4">
                                    <h2 class="card-title text-base">
                                        <a class="link link-hover" href="/pelicula/<%= movie.movie_id %>">
                                            <%= movie.title %> (<%= new Date(movie.release_date).getFullYear() %>)
                                        </a>
                                    </h2>
                                </div>
                            </div>
                        <% }); %>
                    </div>
                <% } %>
            </div>

        </div>

        <!-- Paginado -->
        <div class="join mt-6 flex justify-center">
            <!-- Boton para ir para atras -->
            <% if(personData.offset === 0) {%>
                <button class="join-item btn">«</button>
            <%} else{%>
            <a href= "/persona/<%=personData.person_id%>?offset=<%=personData.offset - 8 %>&order=popularity" class="join-item btn">«</a>
            <%}%>

            <!-- Botton con el nro de pagina -->
            <button class="join-item btn">Page <%=(personData.offset/8)+1%></button>

            <!-- Boton para ir para atras -->
            <% if((personData.offset + 10) >= personData.totalActedMovies) {%>
                <button class="join-item btn">»</button>
            <%} else{%>
            <a href="/persona/<%=personData.person_id%>?offset=<%=personData.offset + 8%>&order=popularity" class="join-item btn">»</a>
            <%}%>
        </div>
    </div>

</div>
</body>
<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const loader = document.getElementById("person-loader");
        const img = document.getElementById("person-image");

        // Nombre de la persona desde EJS
        const personName = "<%= personData.person_name %>";

        // API key pública desde el backend (la inyectás al render)
        const apiKey = "<%= tmdbApiKey %>";

        try {
            // Mostrar loader
            loader.classList.remove("hidden");

            // Buscar persona en TMDB
            const response = await fetch(`https://api.themoviedb.org/3/search/person?api_key=${apiKey}&query=${encodeURIComponent(personName)}`);
            const data = await response.json();

            if (data.results && data.results.length > 0 && data.results[0].profile_path) {
                img.src = `https://image.tmdb.org/t/p/w300${data.results[0].profile_path}`;
            } else {
                img.src = "https://upload.wikimedia.org/wikipedia/commons/a/a3/Image-not-found.png";
            }

            // Cuando la imagen cargue, ocultamos el loader y mostramos la imagen
            img.onload = () => {
                loader.classList.add("hidden");
                img.classList.remove("hidden");
            };

        } catch (err) {
            console.error("Error cargando imagen:", err);
            loader.classList.add("hidden");
            img.src = "https://upload.wikimedia.org/wikipedia/commons/a/a3/Image-not-found.png";
            img.classList.remove("hidden");
        }
    });
</script>
</html>
