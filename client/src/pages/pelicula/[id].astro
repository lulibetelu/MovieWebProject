---
import "../../assets/app.css";
import { API_URL } from "../../data/config";
import DetailLayout from "../../layouts/DetailLayout.astro";

export const prerender = false;

const { id } = Astro.params;

let movie = null;

try {
    const res = await fetch(`${API_URL}/pelicula/${id}`);
    if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
    }
    const data = await res.json();
    movie = data.movie ?? data;
} catch (err) {
    movie = null;
}

const monthNames = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];

let formattedDate = "";
if (movie?.release_date) {
    const date = new Date(movie.release_date);
    if (!isNaN(date.getTime())) {
        const day = date.getDate();
        const month = monthNames[date.getMonth()];
        const year = date.getFullYear();
        formattedDate = `${day}-${month}-${year}`;
    }
}
---

<DetailLayout title={movie?.title ?? "Película"}>
    <section data-theme="movieweb" class="min-h-screen bg-base-100">
        <div class="max-w-6xl mx-auto px-4 md:px-6 py-6 md:py-10">
            <!-- Header -->
            <div class="mb-6 flex items-center justify-between gap-3">
                <a
                        href="/"
                        class="btn btn-outline btn-primary"
                        onclick="
                      event.preventDefault();
                      if (window.history.length > 1) { window.history.back(); return; }
                      try {
                        if (document.referrer) {
                          const r = new URL(document.referrer);
                          if (r.origin === window.location.origin) {
                            window.location.href = r.href;
                            return;
                          }
                        }
                      } catch {}
                      window.location.href = this.href;
                    ">
                    ← Volver
                </a>

                {formattedDate && (
                        <div class="badge badge-primary badge-lg">{formattedDate}</div>
                )}
            </div>

            {
                !movie ? (
                        <div class="alert alert-error">
                            <span>No se pudo cargar la película.</span>
                        </div>
                ) : (
                        <>
                            <!-- Portada + título -->
                            <div class="card lg:card-side bg-base-200/40 border border-primary/20 shadow-lg mb-8">
                                {
                                    movie?.poster_url ? (
                                            <figure class="p-4">
                                                <img
                                                        src={movie.poster_url}
                                                        alt={`Poster de ${movie.title}`}
                                                        class="w-48 md:w-64 rounded-2xl mask mask-squircle border border-primary/30"
                                                        loading="lazy"
                                                />
                                            </figure>
                                    ) : (
                                            <div class="p-4 flex items-center justify-center">
                                                <div class="avatar placeholder">
                                                    <div class="w-40 md:w-56 rounded-2xl bg-primary text-primary-content text-6xl font-black flex items-center justify-center">
                                                        {movie.title?.[0] ?? "?"}
                                                    </div>
                                                </div>
                                            </div>
                                    )
                                }

                                <div class="card-body">
                                    <h1 class="text-3xl md:text-5xl font-extrabold leading-tight">
                                        {movie.title}
                                    </h1>

                                    {movie.tagline && (
                                            <p class="italic opacity-80 text-xl">{movie.tagline}</p>
                                    )}

                                    <div class="flex flex-wrap gap-2 mt-3">
                                        {movie.genre && (
                                                <div class="badge badge-outline">{movie.genre}</div>
                                        )}
                                        {movie.language && (
                                                <div class="badge badge-outline">
                                                    Idioma: {movie.language.toUpperCase()}
                                                </div>
                                        )}
                                        {movie.runtime && (
                                                <div class="badge badge-outline">{movie.runtime} min</div>
                                        )}
                                        {typeof movie.vote_average !== "undefined" && (
                                                <div class="badge badge-outline">
                                                    ⭐ {Number(movie.vote_average).toFixed(1)}
                                                </div>
                                        )}
                                    </div>

                                    {movie.homepage && (
                                            <a href={movie.homepage} target="_blank" class="link link-primary mt-2">
                                                Página oficial
                                            </a>
                                    )}
                                </div>
                            </div>

                            <!-- Información general -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                                {movie.country && (
                                        <div class="stat bg-base-200/50">
                                            <div class="stat-title">País</div>
                                            <div class="stat-value text-lg">{movie.country}</div>
                                        </div>
                                )}
                                {movie.company && (
                                        <div class="stat bg-base-200/50">
                                            <div class="stat-title">Compañía</div>
                                            <div class="stat-value text-lg">{movie.company}</div>
                                        </div>
                                )}
                                {movie.revenue && (
                                        <div class="stat bg-base-200/50">
                                            <div class="stat-title">Recaudación</div>
                                            <div class="stat-value text-lg">${movie.revenue.toLocaleString()}</div>
                                        </div>
                                )}
                                {movie.budget && (
                                        <div class="stat bg-base-200/50">
                                            <div class="stat-title">Presupuesto</div>
                                            <div class="stat-value text-lg">${movie.budget.toLocaleString()}</div>
                                        </div>
                                )}
                            </div>

                <!-- Argumento -->
                {movie.overview && (
                            <div class="card bg-base-200/40 border border-primary/20 shadow-md mb-8">
                                <div class="card-body">
                                    <h3 class="card-title text-primary">Argumento</h3>
                                    <p>{movie.overview}</p>
                                </div>
                            </div>
                    )}

                <!-- Tabs de elenco y equipo -->
                <div class="tabs tabs-lift w-full">
                    <input type="radio" name="tabs" class="tab" aria-label="Elenco" checked />
                    <div class="tab-content bg-base-100 border-base-300 p-6">
                        {
                            (movie.cast ?? []).length === 0 ? (
                                    <p class="opacity-70">No hay elenco disponible.</p>
                            ) : (
                                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                                        {[...movie.cast]
                                            .sort((a,b) => a.cast_order - b.cast_order)
                                            .map(actor => (
                                                    <div class="card bg-base-200/40 border border-base-300 hover:border-primary/40 transition">
                                                        <div class="card-body p-3">
                                                            <h2 class="card-title text-sm font-semibold">
                                                                <a href={`/persona/${actor.actor_id}`} class="link link-primary">
                                                                    {actor.actor_name}
                                                                </a>
                                                            </h2>
                                                            <p class="text-xs opacity-80">{actor.character_name}</p>
                                                        </div>
                                                    </div>
                                            ))}
                                    </div>
                            )
                        }
                    </div>

                    <input type="radio" name="tabs" class="tab" aria-label="Equipo Técnico" />
                    <div class="tab-content bg-base-100 border-base-300 p-6">
                        {
                            (movie.crew ?? []).length === 0 ? (
                                    <p class="opacity-70">No hay equipo técnico disponible.</p>
                            ) : (
                                    <div class="overflow-x-auto">
                                        <table class="table table-zebra">
                                            <thead>
                                            <tr>
                                                <th>Nombre</th>
                                                <th>Puesto</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            {movie.crew.map(crewMember => (
                                                    <tr>
                                                        <td class="whitespace-nowrap">
                                                            {crewMember.crew_member_name}
                                                        </td>
                                                        <td class="whitespace-nowrap">
                                                            {crewMember.job}
                                                        </td>
                                                    </tr>
                                            ))}
                                            </tbody>
                                        </table>
                                    </div>
                            )
                        }
                    </div>
                </div>
                </>
                )
                }
                </div>
                </section>
                </DetailLayout>
