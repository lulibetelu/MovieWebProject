---
import "../../assets/app.css";
import { API_URL } from "../../data/config";
import DetailLayout from "../../layouts/DetailLayout.astro";

export const prerender = false;

const { id } = Astro.params;

let movie = null;

try {
    const res = await fetch(`${API_URL}/pelicula/${id}`);
    if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
    }
    const data = await res.json();
    movie = data.movie ?? data;
} catch (err) {
    movie = null;
}

const monthNames = [
    "Ene",
    "Feb",
    "Mar",
    "Abr",
    "May",
    "Jun",
    "Jul",
    "Ago",
    "Sep",
    "Oct",
    "Nov",
    "Dic",
];

let formattedDate = "";
if (movie?.release_date) {
    const date = new Date(movie.release_date);
    if (!isNaN(date.getTime())) {
        const day = date.getDate();
        const month = monthNames[date.getMonth()];
        const year = date.getFullYear();
        formattedDate = `${day}-${month}-${year}`;
    }
}
---

<DetailLayout title={movie?.title ?? "Película"}>
    <section data-theme="movieweb" class="min-h-screen bg-base-100">
        <div class="max-w-6xl mx-auto px-4 md:px-6 py-6 md:py-10">
            <div class="mb-6 flex items-center justify-between gap-3">
                <a
                href="/"
                class="btn btn-outline btn-primary"
                onclick="
                  event.preventDefault();
                  // si hay historial, volver
                  if (window.history.length > 1) {
                    window.history.back();
                    return;
                  }
                  // si hay referrer del mismo origen, ir ahí
                  try {
                    if (document.referrer) {
                      const r = new URL(document.referrer);
                      if (r.origin === window.location.origin) {
                        window.location.href = r.href;
                        return;
                      }
                    }
                  } catch {}
                  // fallback
                  window.location.href = this.href;
                ">
                    ← Volver
                </a>

                {
                    formattedDate && (
                        <div class="badge badge-primary badge-lg">
                            {formattedDate}
                        </div>
                    )
                }
            </div>

            {
                !movie ? (
                    <div class="space-y-4">
                        <div class="alert alert-error">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10.34 2.49a2 2 0 0 1 3.32 0l8.24 12.87A2 2 0 0 1 20.24 18H3.76a2 2 0 0 1-1.66-2.64L10.34 2.5zM12 9v4m0 4h.01" />
                            </svg>
                            <span>No se pudo cargar la película.</span>
                        </div>
                        <a href="/" class="btn btn-primary">Ir al inicio</a>
                    </div>
                ) : (
                    <>
                        <!-- Hero / Header -->
                        <div class="card lg:card-side bg-base-200/40 border border-primary/20 shadow-lg shadow-primary/10 mb-8">
                            {
                                movie?.poster_url ? (
                                    <figure class="p-4">
                                        <img
                                            src={movie.poster_url}
                                            alt={`Poster de ${movie.title}`}
                                            class="w-48 md:w-64 rounded-2xl mask mask-squircle border border-primary/30"
                                            loading="lazy"
                                        />
                                    </figure>
                                ) : (
                                    <div class="p-4 hidden md:flex items-center justify-center">
                                        <div class="avatar placeholder">
                                            <div class="w-40 md:w-56 rounded-2xl bg-primary text-primary-content text-6xl font-black flex items-center justify-center">
                                                {movie.title?.[0] ?? "?"}
                                            </div>
                                        </div>
                                    </div>
                                )
                            }

                            <div class="card-body">
                                <h1 class="text-3xl md:text-5xl font-extrabold leading-tight">
                                    <span class="text-base-content">{movie.title}</span>
                                </h1>

                                <div class="flex flex-wrap items-center gap-2">
                                    {
                                        (movie.directors ?? []).length > 0 && (
                                            <>
                                                <div class="badge badge-outline">Directores</div>
                                                {(movie.directors ?? []).map((director) => (
                                                    <a
                                                        href={`/persona/${director.crew_member_id}?offset=0&order=popularity`}
                                                        class="badge badge-primary badge-outline hover:badge-primary hover:text-primary-content transition"
                                                    >
                                                        {director.crew_member_name}
                                                    </a>
                                                ))}
                                            </>
                                        )
                                    }
                                </div>

                                <div class="flex flex-wrap gap-2 mt-2">
                                    {
                                        typeof movie?.vote_average !== "undefined" && movie.vote_average !== null && (
                                            <div class="badge badge-secondary badge-lg">
                                                ⭐ {Number(movie.vote_average).toFixed(1)}
                                            </div>
                                        )
                                    }
                                    {
                                        typeof movie?.runtime !== "undefined" && movie.runtime !== null && (
                                            <div class="badge badge-outline">{movie.runtime} min</div>
                                        )
                                    }
                                </div>

                                <div class="card-actions justify-end mt-2">
                                    <a href="/" class="btn btn-primary">Buscar otra</a>
                                </div>
                            </div>
                        </div>

                        <!-- Overview -->
                        {
                            (movie.overview ?? "").trim().length > 0 && (
                                <div class="card bg-base-200/40 border border-primary/20 shadow-md shadow-primary/10 mb-8">
                                    <div class="card-body">
                                        <h3 class="card-title text-primary">Argumento</h3>
                                        <p class="text-base-content/90 leading-relaxed">
                                            {movie.overview}
                                        </p>
                                    </div>
                                </div>
                            )
                        }

                        <!-- Writers -->
                        {
                            (movie.writers ?? []).length > 0 && (
                                <div class="mb-8">
                                    <h3 class="text-xl font-semibold mb-3">Escritores</h3>
                                    <div class="flex flex-wrap gap-2">
                                        {(movie.writers ?? []).map((writer) => (
                                            <span class="badge badge-outline">{writer.crew_member_name}</span>
                                        ))}
                                    </div>
                                </div>
                            )
                        }

                        <!-- Collapsibles -->
                        <div class="flex flex-col w-full">
                            <!-- Cast -->
                            <details class="collapse collapse-arrow bg-base-200/40 border border-primary/20 shadow-sm">
                                <summary class="collapse-title text-lg md:text-xl font-semibold">
                                    Elenco
                                </summary>
                                <div class="collapse-content">
                                    {
                                        (movie.cast ?? []).length === 0 ? (
                                            <p class="opacity-70">No hay elenco disponible.</p>
                                        ) : (
                                            <ul class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                                {[...(movie.cast ?? [])]
                                                    .sort((a, b) => a.cast_order - b.cast_order)
                                                    .map((actor) => (
                                                        <li class="p-3 rounded-lg bg-base-100/60 border border-base-300 hover:border-primary/50 transition">
                                                            <div class="flex items-center gap-3">
                                                                <div class="avatar placeholder">
                                                                    <div class="w-10 h-10 rounded-full bg-primary text-primary-content flex items-center justify-center font-bold">
                                                                        {actor.actor_name?.[0] ?? "?"}
                                                                    </div>
                                                                </div>
                                                                <div class="flex-1 min-w-0">
                                                                    <a href={`/persona/${actor.actor_id}`} class="link link-primary font-medium truncate">
                                                                        {actor.actor_name}
                                                                    </a>
                                                                    <div class="text-sm opacity-70 truncate">
                                                                        {actor.character_name}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </li>
                                                    ))}
                                            </ul>
                                        )
                                    }
                                </div>
                            </div>

                            <!-- Crew -->
                            <div class="collapse collapse-arrow bg-base-200/40 border border-primary/20 shadow-sm">
                                <input type="checkbox" name="crew" />
                                <div class="collapse-title text-lg md:text-xl font-semibold">
                                    Equipo técnico
                                </div>
                                <div class="collapse-content">
                                    {
                                        (movie.crew ?? []).length === 0 ? (
                                            <p class="opacity-70">No hay equipo técnico disponible.</p>
                                        ) : (
                                            <div class="overflow-x-auto">
                                                <table class="table table-zebra">
                                                    <thead>
                                                        <tr>
                                                            <th>Nombre</th>
                                                            <th>Departamento</th>
                                                            <th>Puesto</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {(movie.crew ?? []).map((crewMember) => (
                                                            <tr>
                                                                <td class="whitespace-nowrap">{crewMember.crew_member_name}</td>
                                                                <td class="whitespace-nowrap">{crewMember.department_name}</td>
                                                                <td class="whitespace-nowrap">{crewMember.job}</td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        )
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="mt-10 flex justify-center">
                            <a href="/" class="btn btn-primary btn-wide">Inicio</a>
                        </div>
                    </>
                )
            }
        </div>
    </section>
</DetailLayout>
