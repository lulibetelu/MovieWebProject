---
import "../assets/app.css";
import { API_URL } from "../data/config";

import HomeLayout from "../layouts/HomeLayout.astro";
import MoviesCarousel from "../components/base/MoviesCarousel";
import LaserFlowBox from "../components/ReactBits/LaserFlow/LaserFlowBox";

// Initialize variables to avoid undefined errors
let result = { movies: [], tmdbApiKey: "" };
let tmdbApiKey = "";

/**
 * `movies` es un array de generos (key), con una lista de objetos pel√≠cula (value)
 */

try {
    const response = await fetch(`${API_URL}/top/15`);
    if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
    }
    result = await response.json();
    tmdbApiKey = result.tmdbApiKey || "";
} catch (e) {
    console.error("Error fetching data:", e);
    result = { movies: [{ title: "No movies available" }], tmdbApiKey: "" };
}

// Ensure prerender for static rendering
export const prerender = true;
---

<HomeLayout
    title="Movie Web App"
    class="relative min-h-screen overflow-hidden bg-[#060010]"
>
    <main
        class="relative flex min-h-screen w-full flex-col items-center justify-center"
        data-theme="movieweb"
    >
        <Fragment slot="head">
            <style>
                @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@700&display=swap");
            </style>
        </Fragment>

        <LaserFlowBox client:only="react" />
    </main>

    {
        result.movies.length === 0 ? (
            <div class="flex justify-center items-center h-full">
                <div class="spinner animate-spin inline-block w-8 h-8 border-4 border-primary rounded-full" />
            </div>
        ) : (
            Object.entries(result.movies).map(([genre, movieGroup], idx) => (
                <MoviesCarousel
                    client:visible
                    movieGroup={movieGroup}
                    title={genre}
                    tmdbApiKey={tmdbApiKey}
                    idx={idx}
                />
            ))
        )
    }
</HomeLayout>
